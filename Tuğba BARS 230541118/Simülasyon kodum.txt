from flask import Flask, request, jsonify
import threading
import time
from datetime import datetime, timedelta

app = Flask(_name_)

# Global durum
state = {
    "charging": False,
    "last_heartbeat": None,
    "heartbeat_timeout": 5,
    "anomaly_mode": False
}
state_lock = threading.Lock()
watchdog_thread = None
stop_threads = False

LOG_FILE = "charger_anomaly_log.txt"

def log_anomaly(text):
    ts = datetime.utcnow().isoformat()
    with open(LOG_FILE, "a") as f:
        f.write(f"{ts} - {text}\n")

@app.route("/start_charge", methods=["POST"])
def start_charge():
    with state_lock:
        state["charging"] = True
        state["last_heartbeat"] = datetime.utcnow()
    return jsonify({"status":"charging_started", "charging": True})

@app.route("/stop_charge", methods=["POST"])
def stop_charge():
    with state_lock:
        state["charging"] = False
    return jsonify({"status":"charging_stopped", "charging": False})

@app.route("/heartbeat", methods=["POST"])
def heartbeat():
    with state_lock:
        state["last_heartbeat"] = datetime.utcnow()
    return jsonify({"status":"heartbeat_received", "time": state["last_heartbeat"].isoformat()})

@app.route("/status", methods=["GET"])
def status():
    with state_lock:
        last = state["last_heartbeat"].isoformat() if state["last_heartbeat"] else None
        return jsonify({
            "charging": state["charging"],
            "last_heartbeat": last,
            "anomaly_mode": state["anomaly_mode"],
            "heartbeat_timeout_s": state["heartbeat_timeout"]
        })

@app.route("/set_anomaly", methods=["POST"])
def set_anomaly():
    mode = request.args.get("mode","off").lower()
    with state_lock:
        state["anomaly_mode"] = (mode == "on")
    return jsonify({"anomaly_mode": state["anomaly_mode"]})

def watchdog_loop():
    global stop_threads
    while not stop_threads:
        time.sleep(1)
        with state_lock:
            charging = state["charging"]
            last = state["last_heartbeat"]
            timeout = state["heartbeat_timeout"]
            anomaly_mode = state["anomaly_mode"]

        if charging:
            now = datetime.utcnow()
            if last is None:
                delta = None
            else:
                delta = (now - last).total_seconds()

            if last is None or delta is None or delta > timeout:
                if anomaly_mode:
                    log_anomaly(f"ANOMALY: heartbeat lost but charging CONTINUES. last_heartbeat={last}, delta={delta}")
                else:
                    with state_lock:
                        state["charging"] = False
                    log_anomaly(f"INFO: heartbeat lost -> charging stopped by watchdog. last_heartbeat={last}, delta={delta}")

def start_watchdog_thread():
    global watchdog_thread
    t = threading.Thread(target=watchdog_loop, daemon=True)
    watchdog_thread = t
    t.start()

if _name_ == "_main_":
    try:
        start_watchdog_thread()
        print("ğŸš€ EV Åarj SimÃ¼latÃ¶rÃ¼ baÅŸlatÄ±lÄ±yor...")
        print("ğŸ“¡ Sunucu: http://localhost:5000")
        app.run(host="0.0.0.0", port=5000, debug=True)
    except Exception as e:
        print(f"âŒ Hata: {e}")
    finally:
        stop_threads = True